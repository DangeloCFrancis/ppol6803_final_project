---
title: "Predicting party identification using socioeconomic characterisitcs"
author: "D'Angelo Francis; Su Yeon Seo; Yuxiang 'Nathan' Su"
format: html
---


## Purpose

Our research project seeks to identify the key characteristics to identify and predict how a voter votes. 
 This project utilizes a Classification and Regression Tree model, and 'glm' (logistic and probit regression) models to predict the probability that a survey respondent voted 'conservatively' or 'liberally'[^1]. The primary data for analysis and modeling will be survey data from the [American National Election Studies](https://electionstudies.org/), a collaboration between Duke University,the University of Michigan,the University of Texas at Austin (UT Austin), Stanford University, and the National Science Foundation (NSF).  

For our model, we plan on using questions that the ANES asks about a candidate that voter voted for (*e.g., "Which candidate did you vote for in...?"*) as the outcome variable our model will predict. The goal of our models are to precisely predict which a voter voted for using the responses from survey questions asking about policies, such as transgender rights, gun control, reproductive rights, etc. We will incorporate a variable importance analysis to deduce which survey topics and demographic characteristics are the best indicators of voters' candidate preference.

## Setting up our models 

```{r}
#| label: library setup 
#| message: false
#| warning: false

set.seed(41224) # Euro style date for December 4,2024

# core packages

library(tidyverse)
library(tidymodels) # use case weights 
library(readxl)
library(baguette)
library(vip)
library(pROC)
library(srvyr)

# visualization packages

library(patchwork) # easy combine plots
library(tigris) # direct download of shape files from US Census 
library(sf) # manipulate shapefiles 
library(rgeoboundaries) # international boundaries 
library(ggrepel)  # install.packages("ggrepel")
library(ggthemes) # install.packages("ggthemes")
library(crsuggest) # install.packages("crsuggest")
library(ggarchery) # install.packages("ggarchery") for easy arrows

# Global Options

theme_set(theme_clean())
```

```{r}
#| label: ANES data loading and variable selection 
#| warning: false
#| message: false


# read data in - see README for link

# read data in - see README for link

anes_1948_2020 <- 
  read_csv("data/anes_timeseries_cdf_csv_20220916.csv")

# tidying, getting years to 2000 - 2020 and pre-election vs post-election

anes_2000_2020 <- 
  anes_1948_2020 |>
  select(
    # Year
    VCF0004, 
    
    # Weight
    VCF9999, # post-election weight
    
    # Completion
    VCF0013, # post-election
    VCF0014, # pre-election
    VCF0748, # voted on election day or before
    
    # Dependent Variable(s)
    VCF0302, # initial party identification response
    VCF0303, # party identification response
    VCF0705, # vote for president - major parties and other
    
    # Demographic
    VCF0101, # age
    VCF0104, # gender
    VCF0105b, # race-ethnicity
    VCF0110, # education
    VCF0147, # marital status
    VCF0111, # urbanism (not available after 2000, drop or generated by spatial information)
    
    # Economic Condition
    VCF0114, # family-income
    VCF0116, # work status
    VCF0151, # occupation group (not available)
    VCF0146, # home ownership
    VCF9224, # stock market investment
    
    # Ideology
    VCF0128, # religion
    VCF0201:VCF0291, # attitude to different interest groups
    matches("^VCF08"), # policy preference
    matches("^VCF92"), # political opinion & VCF9277-82 personal info
    
    # Family Information
    VCF0306, # party identification of R's father
    VCF0307, # party identification of R's mother
    VCF0308, # political interest of R's father
    VCF0309, # political interest of R's mother
    VCF0138, # number of children in family
  
    
    # Spatial Information
    VCF0900, # congressional district of residence
    VCF0900b, # state and congressional district - fips
    VCF0900c, # state and congressional district - postal abbrev and cd
    VCF0901a, # state code - fips
    VCF0901b, # state postal abbrev
  ) |>
  filter(VCF0004 %in% c(2000:2020), 
         VCF0014 == 1 & VCF0013 == 1, 
         is.na(VCF9999) == FALSE,
         VCF0748 %in% c(1,5), 
         VCF0705 > 0, # 0 - did not vote, declined to answer
         ) |> 
  # transform missing value to NAs
  mutate(VCF0101 = ifelse(VCF0101 == 0, NA, VCF0101)) |>
  mutate(VCF0104 = ifelse(VCF0104 == 0, NA, VCF0104)) |>
  mutate(VCF0105b = ifelse(VCF0105b == 9, NA, VCF0105b)) |>
  mutate(VCF0110 = ifelse(VCF0110 == 0, NA, VCF0110)) |>
  mutate(VCF0147 = ifelse(VCF0147 %in% c(8,9), NA, VCF0147)) |>
  mutate(VCF0114 = ifelse(VCF0114 == 0, NA, VCF0114)) |>
  mutate(VCF0116 = ifelse(VCF0116 == 9, NA, VCF0116)) |>
  mutate(VCF0146 = ifelse(VCF0146 == 9, NA, VCF0146)) |> # high percentage of missing data
  mutate(VCF9224 = ifelse(VCF9224 %in% c(-8,-9), NA, VCF9224)) |>
  mutate(VCF0128 = ifelse(VCF0128 == 0, NA, VCF0128)) |>
  mutate(across(VCF0201:VCF0253, ~ ifelse(. %in% c(98, 99), NA, .))) |>
  mutate(VCF0290 = ifelse(VCF0290 %in% c(998, 999), NA, VCF0290)) |>
  mutate(VCF0291 = ifelse(VCF0291 %in% c(998, 999), NA, VCF0291)) |>
  mutate(VCF0801 = ifelse(VCF0801 %in% c(98, 99), NA, VCF0801)) |>
  mutate(VCF0803 = ifelse(VCF0803 %in% c(0, 9), NA, VCF0803)) |>
  mutate(VCF0804 = ifelse(VCF0804 %in% c(0, 9), NA, VCF0804)) |>
  mutate(across(VCF0806:VCF0823, ~ ifelse(. %in% c(0, 9), NA, .))) |>
  mutate(VCF0825 = ifelse(VCF0825 %in% c(0, 9), NA, VCF0825)) |>
  mutate(VCF0826 = ifelse(VCF0825 %in% c(0, 9), NA, VCF0825)) |>
  mutate(VCF0828 = ifelse(VCF0828 == 0, NA, VCF0828)) |>
  mutate(VCF0829 = ifelse(VCF0829 == 0, NA, VCF0829)) |>
  mutate(VCF0830 = ifelse(VCF0830 == 0, NA, VCF0830)) |>
  mutate(VCF0838 = ifelse(VCF0838 == 0, NA, VCF0838)) |>
  mutate(VCF0839 = ifelse(VCF0839 == 0, NA, VCF0839)) |>
  mutate(VCF0843 = ifelse(VCF0843 == 0, NA, VCF0843)) |>
  mutate(VCF0846 = ifelse(VCF0846 %in% c(0,8), NA, VCF0846)) |>
  mutate(VCF0849 = ifelse(VCF0849 %in% c(0,9), NA, VCF0849)) |>
  mutate(VCF0850 = ifelse(VCF0850 %in% c(0,9), NA, VCF0850)) |>
  mutate(VCF0852 = ifelse(VCF0852 == 9, NA, VCF0852)) |>
  mutate(VCF0853 = ifelse(VCF0853 == 9, NA, VCF0853)) |>
  mutate(VCF0867 = ifelse(VCF0867 == 9, NA, VCF0867)) |>
  mutate(VCF0870 = ifelse(VCF0870 %in% c(0,8), NA, VCF0870)) |>
  mutate(VCF0871 = ifelse(VCF0871 %in% c(0,8,9), NA, VCF0871)) |>
  mutate(VCF0872 = ifelse(VCF0872 %in% c(8,9), NA, VCF0872)) |>
  mutate(VCF0876 = ifelse(VCF0876 == 9, NA, VCF0876)) |>
  mutate(VCF0876a = ifelse(VCF0876a == 9, NA, VCF0876a)) |>
  mutate(VCF0878 = ifelse(VCF0878 == 9, NA, VCF0878)) |>
  mutate(VCF0879a = ifelse(VCF0879a == 9, NA, VCF0879a)) |>
  mutate(VCF0880 = ifelse(VCF0880 %in% c(0,9), NA, VCF0880)) |>
  mutate(VCF0880a = ifelse(VCF0880a %in% c(0,9), NA, VCF0880a)) |>
  mutate(VCF0881 = ifelse(VCF0881 %in% c(0,9), NA, VCF0881)) |>
  mutate(VCF0886 = ifelse(VCF0886 == 9, NA, VCF0886)) |>
  mutate(VCF0888 = ifelse(VCF0888 == 9, NA, VCF0888)) |>
  mutate(VCF0890 = ifelse(VCF0890 == 9, NA, VCF0890)) |>
  mutate(VCF0894 = ifelse(VCF0894 == 9, NA, VCF0894)) |>
  mutate(VCF0302 = ifelse(VCF0302 %in% c(8,9), NA, VCF0302))|>
  select(-where(~sum(is.na(.)) > 1000)) |>
  select(-c(VCF0004,VCF0901b, VCF0013,VCF0014, VCF0705, VCF0303,VCF0218,VCF0224,
            VCF0291,VCF0218,VCF0218,VCF0211,VCF0290,VCF0212))

anes_2000_2020$VCF0302 <- factor(anes_2000_2020$VCF0302)

```


## Model 1: Random Forests model with resampling

```{r}
#|label: random forests model, using VCF0302 as dependent variable

# Only 39 obs missing in VCF0302 out of thousands; shouldn't impact result if dropped
anes_2000_2020 <- 
  anes_2000_2020 |>
  mutate(VCF9999 = importance_weights(VCF9999)) |> # create recipe case weight
  filter(is.na(VCF0302) == FALSE)

anes_split <- initial_split(anes_2000_2020)

anes_train <- training(x = anes_split)

anes_test <- testing(x = anes_split)

anes_folds <- vfold_cv(data = anes_train, v = 5)

anes_recipe <- 
  recipe(formula = VCF0302~ ., data = anes_train) |>
  step_impute_bag(all_predictors(), trees = 5)
  

anes_rf_mod <- 
    rand_forest(
      trees = 500,
      mtry = 10,
      min_n = 4
    ) |>
  set_mode(mode = "classification") |>
  set_engine(
    engine = "ranger", 
    importance = "impurity",
    num.threads = 4
  )

anes_rf_wf <- 
  workflow() |>
  add_recipe(anes_recipe) |>
  add_model(anes_rf_mod) |>
  add_case_weights(VCF9999)

anes_rf_resamples <- 
  anes_rf_wf |>
  fit_resamples(resamples = anes_folds)

collect_metrics(anes_rf_resamples) # dropping obs doesn't hurt metrics significantly

anes_rf_final <- 
  anes_rf_wf |>
  last_fit(anes_split)

anes_rf_final |>
  collect_metrics()

anes_vip_plot <- 
  anes_rf_final |>
  extract_fit_parsnip() |>
  vip(num_features = 20)

anes_vip_plot + 
  labs(
    title = str_wrap("Variable importance in determining American voter political identification"),
    subtitle = "",
    caption = "")
    

ggsave(filename = "anes_rf_vip_plot_VCF0302.png", width = 11, height = 8.5)

ggsave(filename = "anes_rf_vip_plot_VCF0302.pdf",width = 11, height = 8.5)

anes_rf_final_wf <- 
  anes_rf_final |>
  extract_workflow()

anes_rf_predictions <- 
  predict(anes_rf_final_wf, new_data = anes_test) |>
  bind_cols(
    predict(anes_rf_final_wf, new_data = anes_test, type = "prob"),
    anes_test |>
    select(VCF0302)
  )

select(anes_rf_predictions, VCF0302, starts_with(".pred"))

anes_rf_predictions |>
  precision(
    truth = VCF0302,
    estimate = .pred_class)

anes_rf_predictions |>
  recall(
    truth = VCF0302,
    estimate = .pred_class
  )

anes_rf_confmat <-
  conf_mat(data = anes_rf_predictions,
         truth = VCF0302,
         estimate = .pred_class)

anes_rf_confmat # values for markdown table

```

## Model 2: Bagged Trees with hyperparameter tuning 

```{r}
#|label: bagging with hp tuning

anes_bagged_trees_model <- 
  bag_tree(cost_complexity = tune(), tree_depth = tune()) |>
  set_engine("rpart") |> 
  set_mode("classification")

anes_bagged_folds <- vfold_cv(data = anes_train, v = 5)

anes_bagged_grid <- grid_regular(cost_complexity(),tree_depth(), levels = 3)

anes_bagged_trees_wf <-
  workflow() |>
  add_recipe(anes_recipe) |>
  add_model(spec = anes_bagged_trees_model) |>
  add_case_weights(VCF9999)

anes_bagged_trees_resamples <- 
  anes_bagged_trees_wf |>
  tune_grid(
    resamples = anes_bagged_folds,
    grid = anes_bagged_grid
  )

collect_metrics(anes_bagged_trees_resamples) 

anes_bagged_trees_resamples |>
  show_best(metric = "accuracy")

best_bagged_value <- 
  anes_bagged_trees_resamples |>
  select_best(metric = "accuracy")

anes_bagged_best_wf <- 
  anes_bagged_trees_wf |>
  finalize_workflow(best_bagged_value)
```

Now, we run our bagged tree model with the best parameters given by hyperparameter tuning: 

```{r}
#|label: applying hyperparametering tuning to final bagged tree model

anes_bagged_finalized_fit <- 
  anes_bagged_best_wf |>
  last_fit(anes_split)

anes_bagged_fitted_wf <- 
  anes_bagged_finalized_fit |>
  extract_workflow()

anes_bagged_predictions <-
  predict(anes_bagged_fitted_wf, new_data = anes_test) |>
  bind_cols(
    predict(anes_bagged_fitted_wf, new_data = anes_test, type = "prob"),
    anes_test |>
    select(VCF0302)
  )

select(anes_bagged_predictions, VCF0302, .pred_class, starts_with(".pred"))

anes_bagged_predictions |>
  precision(
    truth = VCF0302,
    estimate = .pred_class)

anes_bagged_predictions |>
  recall(
    truth = VCF0302,
    estimate = .pred_class
  )

anes_bagged_confmat <-
  conf_mat(data = anes_bagged_predictions,
         truth = VCF0302,
         estimate = .pred_class)

anes_bagged_confmat # values for markdown table



```

# Bagged Trees vs Random Forests


## Model 3: Naïve Classification Decision Tree 

```{r}
#|label: decision tree 

# Note: maybe use tuning here? Model doesn't say a lot here (but just enough)

anes_cart_model <- 
  decision_tree() |>
  set_engine(engine = "rpart") |>
  set_mode(mode = "classification")

anes_cart_wf <- 
  workflow() |>
  add_recipe(anes_recipe) |>
  add_model(anes_cart_model) |>
  add_case_weights(VCF9999)
  
anes_cart_fit <- 
  anes_cart_wf |>
  fit(data = anes_train)

# create a tree

rpart.plot::rpart.plot(x = anes_cart_fit$fit$fit$fit)

```


## Using knowledge from above to predict Korean voter sentiment 

```{r}
#| label: setup for using korean survey data

load("data/38577-0001-Data.rda")

icpsr_korean_survey <-
  da38577.0001

# Variable selection data cleaning for NA values 

icpsr_reduced <- 
  icpsr_korean_survey |>
  select(
    PARTYLR, FINALWT,SEX,AGE, MARITAL,EMPLY,EDUC,TECHHIGH,SPEDUC,PAEDUC,MAEDUC,
    RINCOME,INDUSTRY,OCC,SATFIN,FINALTER,STDLIVIN,
    WORRY316,HELPPARE,KIDNUM10,PARSOL,CLASS,HOUSTYPE,HOUSOWNS,BLOODTYP,FEAR,
    FAMILY,FRIENDS,LEISURE,MONEY,EDUCATN,HEALTH,RELIGION,GETAHEAD,
    CULTBIAS1:CULTBIAS12,DONN1:DONN8,INDDIFF,IDEALFAM,MARIGOLD,WOMENCHD,
    LOVCOHAB,WOMENROL,MARABORT,HLPECONO,CHDOBEYP,HUSBWIFE,MARFUTUR,CHDFUTUR,
    FEJOBAFF,MAPAID,ABCHOOSE,HAPMAR,INFORAID,AIDOLD,
    GENCONF1:GENCONF5,OLDWELF1:OLDWELF3,OLDCONT1:OLDCONT3,CONGOVT,NATVSBUS,CURGOV,
    NORTHPOL, DEMOATT1:DEMOATT4)
    
icpsr_reduced <-
  icpsr_reduced |>
  mutate(FINALWT = importance_weights(FINALWT),
         SEX = ifelse(SEX %in% c("-1","-8"), NA, SEX), 
         AGE = ifelse(AGE %in% c("-1","-8"), NA, AGE),
         MARITAL = ifelse(MARITAL %in% c("-1","-8"), NA, MARITAL),
         EMPLY = ifelse(EMPLY %in% c("-1","-8"), NA, EMPLY),
         EDUC = ifelse(EDUC %in% c("-1","-8"), NA, EDUC),
         TECHHIGH = ifelse(TECHHIGH %in% c("-1","-8"), NA, TECHHIGH),
         SPEDUC = ifelse(SPEDUC %in% c("-1","-8"),NA, SPEDUC),
         PAEDUC = ifelse(PAEDUC %in% c("-1","-8"), NA, PAEDUC),
         MAEDUC = ifelse(MAEDUC %in% c("-1","-8"), NA, MAEDUC),
         RINCOME = ifelse(RINCOME %in% c("-1","-8"), NA, RINCOME),
         INDUSTRY = ifelse(INDUSTRY %in% c("-1","-8"), NA, INDUSTRY),
         OCC = ifelse(OCC %in% c("-1","-8"), NA, OCC),
         SATFIN = ifelse(SATFIN %in% c("-1","-8"), NA, SATFIN),
         FINALTER = ifelse(FINALTER %in% c("-1","-8"), NA, FINALTER),
         STDLIVIN = ifelse(STDLIVIN %in% c("-1","-8"), NA, STDLIVIN),
         WORRY316 = ifelse(WORRY316 %in% c("-1","-8"), NA, WORRY316),
         HELPPARE = ifelse(HELPPARE %in% c("-1","-8"), NA, HELPPARE),
         KIDNUM10 = ifelse(KIDNUM10 %in% c("-1","-8"), NA, KIDNUM10),
         PARSOL = ifelse(PARSOL %in% c("-1","-8"), NA, PARSOL),
         CLASS = ifelse(CLASS %in% c("-1","-8"), NA, CLASS),
         HOUSTYPE = ifelse(HOUSTYPE %in% c("-1","-8"), NA, HOUSTYPE),
         HOUSOWNS = ifelse(HOUSOWNS %in% c("-1","-8"), NA, HOUSOWNS),
         BLOODTYP = ifelse(BLOODTYP %in% c("-1","-8"), NA, BLOODTYP),
         FEAR = ifelse(FEAR %in% c("-1","-8"), NA, FEAR),
         FAMILY = ifelse(FAMILY %in% c("-1","-8"), NA, FAMILY),
         FRIENDS = ifelse(FRIENDS %in% c("-1","-8"), NA, FRIENDS),
         LEISURE = ifelse(LEISURE %in% c("-1","-8"), NA, LEISURE),
         MONEY = ifelse(MONEY %in% c("-1","-8"), NA, MONEY),
         EDUCATN = ifelse(EDUCATN %in% c("-1","-8"), NA, EDUCATN),
         HEALTH = ifelse(HEALTH %in% c("-1","-8"), NA, HEALTH),
         RELIGION = ifelse(RELIGION %in% c("-1","-8"), NA, RELIGION),
         GETAHEAD = ifelse(GETAHEAD %in% c("-1","-8"), NA, GETAHEAD),
         CULTBIAS1 = ifelse(CULTBIAS1 %in% c("-1","-8"), NA, CULTBIAS1),
         CULTBIAS2 = ifelse(CULTBIAS2 %in% c("-1","-8"), NA, CULTBIAS1),
         CULTBIAS3 = ifelse(CULTBIAS3 %in% c("-1","-8"), NA, CULTBIAS3),
         CULTBIAS4 = ifelse(CULTBIAS4 %in% c("-1","-8"), NA, CULTBIAS4),
         CULTBIAS5 = ifelse(CULTBIAS5 %in% c("-1","-8"), NA, CULTBIAS5),
         CULTBIAS6 = ifelse(CULTBIAS6 %in% c("-1","-8"), NA, CULTBIAS6),
         CULTBIAS7 = ifelse(CULTBIAS7 %in% c("-1","-8"), NA, CULTBIAS7),
         CULTBIAS8 = ifelse(CULTBIAS8 %in% c("-1","-8"), NA, CULTBIAS8),
         CULTBIAS9 = ifelse(CULTBIAS9 %in% c("-1","-8"), NA, CULTBIAS9),
         CULTBIAS10 = ifelse(CULTBIAS10 %in% c("-1","-8"), NA, CULTBIAS10),
         CULTBIAS11 = ifelse(CULTBIAS11 %in% c("-1","-8"), NA, CULTBIAS11),
         CULTBIAS12 = ifelse(CULTBIAS12 %in% c("-1","-8"), NA, CULTBIAS12),
         DONN1 = ifelse(DONN1 %in% c("-1","-8"), NA, DONN1),
         DONN2 = ifelse(DONN2 %in% c("-1","-8"), NA, DONN2),
         DONN3 = ifelse(DONN3 %in% c("-1","-8"), NA, DONN3),
         DONN4 = ifelse(DONN4 %in% c("-1","-8"), NA, DONN4),
         DONN5 = ifelse(DONN5 %in% c("-1","-8"), NA, DONN5),
         DONN6 = ifelse(DONN6 %in% c("-1","-8"), NA, DONN6),
         DONN7 = ifelse(DONN7 %in% c("-1","-8"), NA, DONN7),
         DONN8 = ifelse(DONN8 %in% c("-1","-8"), NA, DONN8),
         INDDIFF = ifelse(INDDIFF %in% c("-1","-8"), NA, INDDIFF),
         IDEALFAM = ifelse(IDEALFAM %in% c("-1","-8"), NA, IDEALFAM),
         MARIGOLD = ifelse(MARIGOLD %in% c("-1","-8"), NA, MARIGOLD),
         WOMENCHD = ifelse(WOMENCHD %in% c("-1","-8"), NA, WOMENCHD),
         LOVCOHAB = ifelse(LOVCOHAB %in% c("-1","-8"), NA, LOVCOHAB),
         WOMENROL = ifelse(WOMENROL %in% c("-1","-8"), NA, WOMENROL),
         MARABORT = ifelse(MARABORT %in% c("-1","-8"), NA, MARABORT),
         HLPECONO = ifelse(HLPECONO %in% c("-1","-8"), NA, HLPECONO),
         CHDOBEYP = ifelse(CHDOBEYP %in% c("-1","-8"), NA, CHDOBEYP),
         HUSBWIFE = ifelse(HUSBWIFE %in% c("-1","-8"), NA, HUSBWIFE),
         MARFUTUR = ifelse(MARFUTUR %in% c("-1","-8"), NA, MARFUTUR),
         CHDFUTUR = ifelse(CHDFUTUR %in% c("-1","-8"), NA, CHDFUTUR),
         FEJOBAFF = ifelse(FEJOBAFF %in% c("-1","-8"), NA, FEJOBAFF),
         MAPAID = ifelse(MAPAID  %in% c("-1","-8"), NA, MAPAID),
         ABCHOOSE = ifelse(ABCHOOSE %in% c("-1","-8"), NA, ABCHOOSE),
         HAPMAR = ifelse(HAPMAR %in% c("-1","-8"), NA, HAPMAR),
         INFORAID = ifelse(INFORAID %in% c("-1","-8"), NA, INFORAID),
         AIDOLD = ifelse(AIDOLD %in% c("-1","-8"), NA, AIDOLD),
         GENCONF1 = ifelse(GENCONF1 %in% c("-1","-8"), NA, GENCONF1),
         GENCONF2 = ifelse(GENCONF2 %in% c("-1","-8"), NA, GENCONF2),
         GENCONF3 = ifelse(GENCONF3 %in% c("-1","-8"), NA, GENCONF3),
         GENCONF4 = ifelse(GENCONF4 %in% c("-1","-8"), NA, GENCONF4),
         GENCONF5 = ifelse(GENCONF5 %in% c("-1","-8"), NA, GENCONF5),
         OLDWELF1 = ifelse(OLDWELF1 %in% c("-1","-8"), NA, OLDWELF1),
         OLDWELF2 = ifelse(OLDWELF2 %in% c("-1","-8"), NA, OLDWELF2),
         OLDWELF3 = ifelse(OLDWELF3 %in% c("-1","-8"), NA, OLDWELF3),
         OLDCONT1 = ifelse(OLDCONT1 %in% c("-1","-8"), NA, OLDCONT1),
         OLDCONT2 = ifelse(OLDCONT2 %in% c("-1","-8"), NA, OLDCONT2),
         OLDCONT3 = ifelse(OLDCONT3 %in% c("-1","-8"), NA, OLDCONT3),
         CONGOVT = ifelse(CONGOVT %in% c("-1","-8"), NA, CONGOVT),
         NATVSBUS = ifelse(NATVSBUS %in% c("-1","-8"), NA, NATVSBUS),
         CURGOV = ifelse(CURGOV %in% c("-1","-8"), NA, CURGOV),
         NORTHPOL = ifelse(NORTHPOL %in% c("-1","-8"), NA, NORTHPOL),
         DEMOATT1 = ifelse(DEMOATT1 %in% c("-1","-8"), NA, DEMOATT1),
         DEMOATT2 = ifelse(DEMOATT2 %in% c("-1","-8"), NA, DEMOATT2),
         DEMOATT3 = ifelse(DEMOATT3 %in% c("-1","-8"), NA, DEMOATT3),
         DEMOATT4 = ifelse(DEMOATT4 %in% c("-1","-8"), NA, DEMOATT4),
         PARTYLR = ifelse(PARTYLR %in% c("-1", "-8"), NA, PARTYLR),
         PARTYLR = factor(PARTYLR)
  )

icpsr_reduced |>
  count(is.na(PARTYLR))

# PARTYLR is outcome variable 

icpsr_split <- 
  icpsr_reduced |>
  initial_split(prop = .75)

icpsr_train <- training(icpsr_split) 

icpsr_test <- testing(icpsr_split)

icpsr_folds <- vfold_cv(data = icpsr_train, v = 5)




icpsr_recipe <-
  recipe(PARTYLR~., data = icpsr_train) |>
  step_impute_bag(all_predictors(), trees = 2) # can't go more than 2 trees or else runtime issues

icpsr_model <-
  rand_forest(
    trees = 500,
    mtry = 5,
    min_n = 4
  ) |>
  set_mode("classification") |>
  set_engine(
    engine = "ranger",
    importance = "impurity",
    num.threads = 4
  )
  
icpsr_rf_wf <- 
  workflow() |>
  add_recipe(icpsr_recipe) |>
  add_model(icpsr_model) |>
  add_case_weights(FINALWT)

icpsr_resamples <- 
  icpsr_rf_wf |>
  fit_resamples(resamples = icpsr_folds)

collect_metrics(icpsr_resamples) # the model sucks....

icpsr_rf_final <- 
  icpsr_rf_wf |>
  last_fit(icpsr_split)

icpsr_vip_plot <- 
  icpsr_rf_final |>
  extract_fit_parsnip() |>
  vip(num_features = 20)

icpsr_vip_plot +
  labs(
    title = str_wrap("Variable importance in determining South Korean voter political identification"),
    subtitle = "",
    caption = "")

ggsave(filename = "icpsr_vip_plot.png", width = 11, height = 8.5)

ggsave(filename = "icpsr_vip_plot.pdf", width = 11, height = 8.5)

```

## Comparison of American voter identification and South Korean voter identification

```{r}
#| label: vip plot comparison 

anes_vip_plot +
  labs(title ="American Voter") + icpsr_vip_plot + 
  labs(title = "South Korean Voter")


```
